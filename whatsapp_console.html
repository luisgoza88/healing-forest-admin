<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consola WhatsApp - Healing Forest</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #1e3a3f;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .status-bar {
        display: flex;
        gap: 20px;
        padding: 15px;
        background: #e0f2fe;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #16a34a;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #1e3a3f;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #666;
        font-weight: 500;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }

      .form-group textarea {
        min-height: 150px;
        resize: vertical;
      }

      .recipients-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 15px;
      }

      .recipient-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
      }

      .recipient-item:last-child {
        border-bottom: none;
      }

      .recipient-item input[type='checkbox'] {
        margin-right: 10px;
      }

      .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #16a34a;
        color: white;
      }

      .btn-primary:hover {
        background: #15803d;
      }

      .btn-secondary {
        background: #6b7280;
        color: white;
        margin-right: 10px;
      }

      .btn-whatsapp {
        background: #25d366;
        color: white;
        width: 100%;
        padding: 18px;
        font-size: 18px;
      }

      .btn-whatsapp:hover {
        background: #20bd5a;
      }

      .message-templates {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .template-btn {
        padding: 8px 16px;
        background: #e5e7eb;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .template-btn:hover {
        background: #d1d5db;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-box {
        padding: 20px;
        background: #f9fafb;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: #16a34a;
      }

      .stat-label {
        color: #6b7280;
        font-size: 14px;
        margin-top: 5px;
      }

      .log-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
      }

      .log-item {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }

      .log-success {
        background: #d1fae5;
      }

      .log-error {
        background: #fee2e2;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #25d366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .quick-numbers {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .quick-number {
        padding: 8px 16px;
        background: #d1fae5;
        border: 1px solid #16a34a;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        color: #16a34a;
        font-weight: 500;
      }

      .quick-number:hover {
        background: #16a34a;
        color: white;
      }

      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üì± Consola de WhatsApp Masivo</h1>
        <p style="color: #6b7280; margin-top: 10px">
          Env√≠a mensajes personalizados a tus pacientes
        </p>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot"></div>
          <span>WhatsApp Conectado</span>
        </div>
        <div class="status-item">
          <span>Modo: Sandbox Twilio</span>
        </div>
        <div class="status-item">
          <span>N√∫mero: +14155238886</span>
        </div>
      </div>

      <div class="main-grid">
        <!-- Panel de env√≠o -->
        <div class="card">
          <h2>üí¨ Nuevo Mensaje</h2>

          <div class="form-group">
            <label>Tipo de env√≠o</label>
            <select id="sendType" onchange="toggleRecipientType()">
              <option value="single">Individual</option>
              <option value="group">Grupo espec√≠fico</option>
              <option value="all">Todos los pacientes</option>
              <option value="custom">N√∫meros personalizados</option>
            </select>
          </div>

          <div id="singleRecipient" class="form-group">
            <label>N√∫mero de WhatsApp</label>
            <input
              type="tel"
              id="phoneNumber"
              placeholder="+57..."
              value="+573102962552"
            />
            <div class="quick-numbers">
              <div class="quick-number" onclick="setPhone('+573102962552')">
                Tu n√∫mero
              </div>
              <div class="quick-number" onclick="setPhone('+573023040979')">
                N√∫mero prueba
              </div>
            </div>
          </div>

          <div id="customNumbers" class="form-group" style="display: none">
            <label>N√∫meros (uno por l√≠nea)</label>
            <textarea
              id="customNumbersList"
              placeholder="+573102962552
+573023040979
+57..."
            ></textarea>
          </div>

          <div id="groupRecipient" class="form-group" style="display: none">
            <label>Seleccionar pacientes</label>
            <div class="recipients-list" id="patientsList">
              <!-- Se carga din√°micamente -->
            </div>
            <button class="btn btn-secondary" onclick="selectAll()">
              Seleccionar todos
            </button>
            <button class="btn btn-secondary" onclick="selectNone()">
              Deseleccionar
            </button>
          </div>

          <div class="form-group">
            <label>Plantillas r√°pidas</label>
            <div class="message-templates">
              <button class="template-btn" onclick="useTemplate('reminder')">
                üìÖ Recordatorio
              </button>
              <button class="template-btn" onclick="useTemplate('promo')">
                üéÅ Promoci√≥n
              </button>
              <button class="template-btn" onclick="useTemplate('birthday')">
                üéÇ Cumplea√±os
              </button>
              <button class="template-btn" onclick="useTemplate('followup')">
                üë®‚Äç‚öïÔ∏è Seguimiento
              </button>
              <button class="template-btn" onclick="useTemplate('vaccine')">
                üíâ Vacunaci√≥n
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Mensaje</label>
            <textarea id="message" placeholder="Escribe tu mensaje aqu√≠...">
üå≥ *Healing Forest*

¬°Hola! üëã

Este es un mensaje de prueba desde la consola administrativa.

_Responde STOP para no recibir m√°s mensajes_</textarea
            >
          </div>

          <button class="btn btn-whatsapp" onclick="sendMessages()">
            Enviar WhatsApp üöÄ
          </button>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Enviando mensajes...</p>
          </div>
        </div>

        <!-- Panel de estad√≠sticas y logs -->
        <div>
          <div class="card" style="margin-bottom: 30px">
            <h2>üìä Estad√≠sticas de Env√≠o</h2>
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-number" id="statSent">0</div>
                <div class="stat-label">Enviados</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="statDelivered">0</div>
                <div class="stat-label">Entregados</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="statFailed">0</div>
                <div class="stat-label">Fallidos</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="statPending">0</div>
                <div class="stat-label">Pendientes</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>üìù Registro de Env√≠os</h2>
            <div class="log-container" id="logContainer">
              <!-- Logs din√°micos -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase config
      const firebaseConfig = window.AppConfig.firebase;
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Variables globales
      let patients = [];
      let stats = {
        sent: 0,
        delivered: 0,
        failed: 0,
        pending: 0,
      };

      // Cargar pacientes
      async function loadPatients() {
        try {
          const snapshot = await db
            .collection('users')
            .where('role', '==', 'patient')
            .get();

          patients = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          renderPatientsList();
        } catch (error) {
          console.error('Error loading patients:', error);
        }
      }

      // Renderizar lista de pacientes
      function renderPatientsList() {
        const list = document.getElementById('patientsList');
        list.innerHTML = patients
          .map(
            (patient) => `
                <div class="recipient-item">
                    <input type="checkbox" id="patient_${patient.id}" value="${patient.phone || ''}">
                    <label for="patient_${patient.id}">
                        ${patient.name || 'Sin nombre'} - ${patient.phone || 'Sin tel√©fono'}
                    </label>
                </div>
            `
          )
          .join('');
      }

      // Toggle tipo de destinatario
      function toggleRecipientType() {
        const type = document.getElementById('sendType').value;
        document.getElementById('singleRecipient').style.display =
          type === 'single' ? 'block' : 'none';
        document.getElementById('groupRecipient').style.display =
          type === 'group' ? 'block' : 'none';
        document.getElementById('customNumbers').style.display =
          type === 'custom' ? 'block' : 'none';
      }

      // Seleccionar todos
      function selectAll() {
        document
          .querySelectorAll('#patientsList input[type="checkbox"]')
          .forEach((cb) => {
            cb.checked = true;
          });
      }

      // Deseleccionar todos
      function selectNone() {
        document
          .querySelectorAll('#patientsList input[type="checkbox"]')
          .forEach((cb) => {
            cb.checked = false;
          });
      }

      // Establecer n√∫mero r√°pido
      function setPhone(number) {
        document.getElementById('phoneNumber').value = number;
      }

      // Usar plantilla
      function useTemplate(type) {
        const templates = {
          reminder: `üå≥ *Healing Forest*

Hola {nombre}! üëã

Te recordamos tu cita:
üìÖ Ma√±ana
‚è∞ {hora}
üë®‚Äç‚öïÔ∏è {doctor}

üìç Direcci√≥n: Calle 123 #45-67

_Responde SI para confirmar_`,

          promo: `üéÅ *Promoci√≥n Especial*

¬°{nombre}, tenemos una oferta para ti!

30% de descuento en:
‚ú® Limpieza dental
‚ú® Valoraci√≥n general
‚ú® Primera consulta

V√°lido hasta: {fecha}

Agenda tu cita respondiendo a este mensaje üì±`,

          birthday: `üéÇ *¬°Feliz Cumplea√±os!*

{nombre}, el equipo de Healing Forest te desea un maravilloso d√≠a üéâ

Como regalo especial:
üéÅ 20% dcto en cualquier servicio
üéÅ Valoraci√≥n gratis

¬°Te esperamos! üå≥`,

          followup: `üë®‚Äç‚öïÔ∏è *Seguimiento M√©dico*

Hola {nombre},

Han pasado 30 d√≠as desde tu √∫ltima visita. ¬øC√≥mo te has sentido?

Recuerda que tu salud es importante para nosotros.

¬øNecesitas agendar una cita de control?`,

          vaccine: `üíâ *Recordatorio de Vacunaci√≥n*

{nombre}, seg√∫n nuestros registros es momento de:

üìã {vacuna}
üìÖ Fecha sugerida: {fecha}

Agenda tu cita para proteger tu salud.

Responde para m√°s informaci√≥n.`,
        };

        document.getElementById('message').value = templates[type] || '';
      }

      // Enviar mensajes
      async function sendMessages() {
        const type = document.getElementById('sendType').value;
        const message = document.getElementById('message').value;

        if (!message.trim()) {
          alert('Por favor escribe un mensaje');
          return;
        }

        document.getElementById('loading').style.display = 'block';

        let recipients = [];

        // Obtener destinatarios seg√∫n el tipo
        switch (type) {
          case 'single':
            const phone = document.getElementById('phoneNumber').value;
            if (phone) recipients.push({ phone, name: 'Usuario' });
            break;

          case 'custom':
            const customNumbers = document
              .getElementById('customNumbersList')
              .value.split('\n')
              .filter((n) => n.trim())
              .map((n) => ({ phone: n.trim(), name: 'Usuario' }));
            recipients = customNumbers;
            break;

          case 'group':
            const checkboxes = document.querySelectorAll(
              '#patientsList input[type="checkbox"]:checked'
            );
            checkboxes.forEach((cb) => {
              if (cb.value) {
                const patient = patients.find((p) => p.phone === cb.value);
                recipients.push({
                  phone: cb.value,
                  name: patient?.name || 'Paciente',
                });
              }
            });
            break;

          case 'all':
            recipients = patients
              .filter((p) => p.phone)
              .map((p) => ({
                phone: p.phone,
                name: p.name || 'Paciente',
              }));
            break;
        }

        if (recipients.length === 0) {
          alert('No hay destinatarios seleccionados');
          document.getElementById('loading').style.display = 'none';
          return;
        }

        // Enviar mensajes
        for (const recipient of recipients) {
          await sendSingleMessage(recipient, message);
          // Esperar un poco entre mensajes para no saturar
          await new Promise((resolve) => setTimeout(resolve, 1000));
        }

        document.getElementById('loading').style.display = 'none';
        updateStats();
      }

      // Enviar mensaje individual
      async function sendSingleMessage(recipient, message) {
        const personalizedMessage = message
          .replace('{nombre}', recipient.name)
          .replace('{fecha}', new Date().toLocaleDateString())
          .replace('{hora}', '10:00 AM')
          .replace('{doctor}', 'Dr. Mart√≠nez')
          .replace('{vacuna}', 'Refuerzo COVID-19');

        try {
          // Guardar en Firebase
          const logEntry = {
            to: recipient.phone,
            message: personalizedMessage,
            status: 'sending',
            timestamp: new Date(),
            type: 'bulk',
          };

          const docRef = await db.collection('whatsapp_logs').add(logEntry);

          // Simular env√≠o (en producci√≥n esto llamar√≠a al servidor)
          stats.sent++;
          addLog(recipient.phone, 'Enviando...', 'pending');

          // Simular respuesta despu√©s de 2 segundos
          setTimeout(async () => {
            const success = Math.random() > 0.1; // 90% √©xito

            if (success) {
              stats.delivered++;
              stats.pending--;
              await db.collection('whatsapp_logs').doc(docRef.id).update({
                status: 'delivered',
                deliveredAt: new Date(),
              });
              updateLog(recipient.phone, '‚úÖ Entregado', 'success');
            } else {
              stats.failed++;
              stats.pending--;
              await db.collection('whatsapp_logs').doc(docRef.id).update({
                status: 'failed',
                error: 'N√∫mero no v√°lido',
              });
              updateLog(recipient.phone, '‚ùå Fall√≥', 'error');
            }

            updateStats();
          }, 2000);

          stats.pending++;
          updateStats();
        } catch (error) {
          console.error('Error:', error);
          stats.failed++;
          addLog(recipient.phone, '‚ùå Error: ' + error.message, 'error');
          updateStats();
        }
      }

      // Agregar log
      function addLog(number, status, type) {
        const logContainer = document.getElementById('logContainer');
        const logItem = document.createElement('div');
        logItem.className = `log-item ${type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : ''}`;
        logItem.innerHTML = `
                <div>
                    <strong>${number}</strong>
                    <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">
                        ${new Date().toLocaleTimeString()}
                    </div>
                </div>
                <div>${status}</div>
            `;
        logContainer.insertBefore(logItem, logContainer.firstChild);
      }

      // Actualizar log existente
      function updateLog(number, newStatus, type) {
        const logs = document.querySelectorAll('.log-item');
        for (const log of logs) {
          if (
            log.innerHTML.includes(number) &&
            log.innerHTML.includes('Enviando...')
          ) {
            log.className = `log-item ${type === 'success' ? 'log-success' : 'log-error'}`;
            log.querySelector('div:last-child').textContent = newStatus;
            break;
          }
        }
      }

      // Actualizar estad√≠sticas
      function updateStats() {
        document.getElementById('statSent').textContent = stats.sent;
        document.getElementById('statDelivered').textContent = stats.delivered;
        document.getElementById('statFailed').textContent = stats.failed;
        document.getElementById('statPending').textContent = stats.pending;
      }

      // Cargar datos hist√≥ricos
      async function loadHistoricalStats() {
        try {
          const oneHourAgo = new Date();
          oneHourAgo.setHours(oneHourAgo.getHours() - 1);

          const snapshot = await db
            .collection('whatsapp_logs')
            .where('timestamp', '>', oneHourAgo)
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();

          snapshot.docs.forEach((doc) => {
            const data = doc.data();
            const status =
              data.status === 'delivered'
                ? '‚úÖ Entregado'
                : data.status === 'failed'
                  ? '‚ùå Fall√≥'
                  : '‚è≥ Pendiente';
            const type =
              data.status === 'delivered'
                ? 'success'
                : data.status === 'failed'
                  ? 'error'
                  : 'pending';

            addLog(data.to, status, type);
          });
        } catch (error) {
          console.error('Error loading history:', error);
        }
      }

      // Inicializar
      window.onload = () => {
        loadPatients();
        loadHistoricalStats();
      };
    </script>
  </body>
</html>
